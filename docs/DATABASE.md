# Database Setup and Management

## Overview

This project uses PostgreSQL running in a Docker container for persistent data storage. The setup is designed for a development workstation with safety and resilience in mind.

## Configuration

**Container Details:**
- Name: `copilot-cli-postgres`
- Image: `postgres:16-alpine`
- Port: `5434` (host) → `5432` (container)
  - Non-standard port to avoid conflicts with other PostgreSQL instances
- Volume: `copilot-cli-pgdata` (persistent storage)
- Database: `copilot_cli`
- User: `copilot_user`
- Password: Auto-generated, stored in `.env`

## Setup Script

The [`scripts/setup-postgres.sh`](../scripts/setup-postgres.sh) script handles all database operations.

### Initial Setup

```bash
# Preview what will happen (safe, no changes)
./scripts/setup-postgres.sh --dry-run

# Actually create and start the database
./scripts/setup-postgres.sh

# Or explicitly:
./scripts/setup-postgres.sh --setup
```

**What it does:**
1. Detects your Fedora environment
2. Checks Docker is available and running
3. Verifies port 5434 is available
4. Generates a secure random password
5. Creates `.env` file with credentials
6. Creates Docker volume for data persistence
7. Starts PostgreSQL container
8. Waits for PostgreSQL to be ready

### Daily Operations

```bash
# Check status
./scripts/setup-postgres.sh --status

# Start the database
./scripts/setup-postgres.sh --start

# Stop the database
./scripts/setup-postgres.sh --stop

# Preview any operation
./scripts/setup-postgres.sh --dry-run --stop
```

## Connection Information

After setup, connection details are stored in `.env`:

```bash
POSTGRES_PASSWORD=<auto-generated>
POSTGRES_USER=copilot_user
POSTGRES_DB=copilot_cli
POSTGRES_HOST=localhost
POSTGRES_PORT=5434
DATABASE_URL=postgresql://copilot_user:<password>@localhost:5434/copilot_cli
```

**Security:**
- `.env` file is gitignored (never committed)
- File permissions set to `600` (only you can read)
- Password is 25 characters, cryptographically random

## Connecting to the Database

### From Host Machine

```bash
# Using psql (if installed)
psql "$(grep DATABASE_URL .env | cut -d= -f2)"

# Or with explicit parameters
source .env
psql -h localhost -p $POSTGRES_PORT -U $POSTGRES_USER -d $POSTGRES_DB
```

### From Docker

```bash
docker exec -it copilot-cli-postgres psql -U copilot_user -d copilot_cli
```

### From Application Code

```bash
# Load connection string
source .env
echo $DATABASE_URL

# Use in your application (Node.js example)
# const { Pool } = require('pg');
# const pool = new Pool({ connectionString: process.env.DATABASE_URL });
```

## Troubleshooting

### Port Already in Use

If port 5434 is occupied:
1. Find the conflicting process: `ss -tuln | grep 5434`
2. Either stop it or change `POSTGRES_PORT` in the script
3. Edit line 13 of `scripts/setup-postgres.sh`:
   ```bash
   readonly POSTGRES_PORT="5435"  # Or any free port
   ```

### Container Won't Start

Check logs:
```bash
docker logs copilot-cli-postgres
tail -f logs/postgres-setup.log
```

### Reset Everything

```bash
# Stop and remove container
docker stop copilot-cli-postgres
docker rm copilot-cli-postgres

# Remove volume (⚠️ deletes all data!)
docker volume rm copilot-cli-pgdata

# Remove credentials
rm .env

# Start fresh
./scripts/setup-postgres.sh
```

### Connection Refused

```bash
# Check container is running
docker ps | grep copilot-cli-postgres

# Check PostgreSQL is ready
docker exec copilot-cli-postgres pg_isready -U copilot_user

# Start if stopped
./scripts/setup-postgres.sh --start
```

## Data Persistence

- Data is stored in Docker volume `copilot-cli-pgdata`
- Survives container restarts
- Persists even if container is removed
- Only deleted if you explicitly remove the volume

## Backup and Restore

### Backup

```bash
# Source credentials
source .env

# Create backup
docker exec copilot-cli-postgres pg_dump -U $POSTGRES_USER $POSTGRES_DB > backup.sql

# Or backup entire cluster
docker exec copilot-cli-postgres pg_dumpall -U $POSTGRES_USER > backup-all.sql
```

### Restore

```bash
# Source credentials
source .env

# Restore from backup
cat backup.sql | docker exec -i copilot-cli-postgres psql -U $POSTGRES_USER -d $POSTGRES_DB
```

## For AI Agents

**When working with the database:**

1. **Always check status first:**
   ```bash
   ./scripts/setup-postgres.sh --status
   ```

2. **If database needed but not running:**
   ```bash
   # Start it
   ./scripts/setup-postgres.sh --start
   ```

3. **For queries, use safe read-only approaches:**
   ```bash
   # Source credentials
   source .env
   
   # Execute safe query
   docker exec copilot-cli-postgres psql -U $POSTGRES_USER -d $POSTGRES_DB -c "SELECT version();"
   ```

4. **Never execute without understanding:**
   - Preview all operations
   - Understand the query/command
   - Consider impact
   - Log the operation

5. **For schema changes:**
   - Create a migration script in `scripts/migrations/`
   - Test on backup first
   - Document the change
   - Get approval

## Logs

All setup operations are logged to:
```
logs/postgres-setup.log
```

Check this file for detailed information about what happened.

---

**Related:**
- [Main README](../README.md)
- [Safety Guidelines](../SAFETY_GUIDELINES.md)
- [Scripts Reference](./SCRIPTS.md)
